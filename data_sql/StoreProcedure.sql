
--EXEC USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT
--/////////////////////////////////////////////////////////
--USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT
--/////////////////////////////////////////////////////////
IF OBJECT_ID ( 'USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT', 'P' ) IS NOT NULL 
    DROP PROCEDURE USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT
go
CREATE PROCEDURE [dbo].[USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT]
	--ATRIBUTES OF TABLA SICOP_CONTROLPRESUPUESTAL WITH SICOP_DETALLECONTROLPRESUPUESTAL

	AS
/*
	NOMBRE				: USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT
	DESCRIPCION			: REPORTE DE CONTROL PRESUPUESTA CON SU DETALLE
	FECHA				: 04-09-2015
	AUTOR				: TEOFILO CHAMBILLA AQUINO
	ARGUMENTOS			:
	FEC. MODIFIC		: 
	AUTOR MODIFIC		: 
	CAMBIOS IMPORTANTE	: 
*/
SET NOCOUNT OFF;

CREATE TABLE #TABLE_TEMP (
CPRE_INT_IDCONTROLPRESUPUESTAL INT,
EGAS_VCH_IDESPECIFICADEGASTO VARCHAR(13) ,
EGAS_VCH_DESCRIPCION VARCHAR(200),
DOCU_VCH_NOMBRE VARCHAR(100),
CPRE_VCH_NRODOCUMENTO VARCHAR(10),
CPRE_DAT_FECHAINGRESO DATETIME,
CPRE_VCH_NROCOMPROBANTEPAGO VARCHAR(10), 
CPRE_VCH_NROSIAF VARCHAR(10), 
CPRE_DAT_FECHAGIRO DATETIME, 
CPRE_DAT_FECHAPAGO DATETIME,
CPRE_VCH_CONCEPTOESPECIFICADEGASTO VARCHAR(200),
CPRE_VCH_DETALLEESPECIFICADEGASTO VARCHAR(200),
META_VCH_META_34 DECIMAL(10,3),
META_VCH_META_62 DECIMAL(10,3),
META_VCH_META_63 DECIMAL(10,3)
);
INSERT INTO #TABLE_TEMP(
CPRE_INT_IDCONTROLPRESUPUESTAL ,
EGAS_VCH_IDESPECIFICADEGASTO ,
EGAS_VCH_DESCRIPCION ,
DOCU_VCH_NOMBRE ,
CPRE_VCH_NRODOCUMENTO ,
CPRE_DAT_FECHAINGRESO ,
CPRE_VCH_NROCOMPROBANTEPAGO , 
CPRE_VCH_NROSIAF , 
CPRE_DAT_FECHAGIRO , 
CPRE_DAT_FECHAPAGO ,
CPRE_VCH_CONCEPTOESPECIFICADEGASTO ,
CPRE_VCH_DETALLEESPECIFICADEGASTO,
META_VCH_META_34  ,
META_VCH_META_62  ,
META_VCH_META_63 
)
SELECT 
CP.CPRE_INT_IDCONTROLPRESUPUESTAL ,
EGA.EGAS_VCH_IDESPECIFICADEGASTO ,
EGA.EGAS_VCH_DESCRIPCION ,
DOC.DOCU_VCH_NOMBRE  ,
CP.CPRE_VCH_NRODOCUMENTO ,
CP.CPRE_DAT_FECHAINGRESO ,
CP.CPRE_VCH_NROCOMPROBANTEPAGO , 
CP.CPRE_VCH_NROSIAF , 
CP.CPRE_DAT_FECHAGIRO , 
CP.CPRE_DAT_FECHAPAGO ,
CP.CPRE_VCH_CONCEPTOESPECIFICADEGASTO ,
CP.CPRE_VCH_DETALLEESPECIFICADEGASTO  ,
(SELECT DCPR_DEC_IMPORTE   
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE EGAS_VCH_IDESPECIFICADEGASTO=EGA.EGAS_VCH_IDESPECIFICADEGASTO  AND
			CPRE_INT_IDCONTROLPRESUPUESTAL=CP.CPRE_INT_IDCONTROLPRESUPUESTAL  AND
			META_VCH_IDMETA='0034'),
(SELECT DCPR_DEC_IMPORTE   
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE EGAS_VCH_IDESPECIFICADEGASTO=EGA.EGAS_VCH_IDESPECIFICADEGASTO AND
			CPRE_INT_IDCONTROLPRESUPUESTAL=CP.CPRE_INT_IDCONTROLPRESUPUESTAL  AND
			META_VCH_IDMETA='0062'),
(SELECT DCPR_DEC_IMPORTE   
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE EGAS_VCH_IDESPECIFICADEGASTO=EGA.EGAS_VCH_IDESPECIFICADEGASTO AND
			CPRE_INT_IDCONTROLPRESUPUESTAL=CP.CPRE_INT_IDCONTROLPRESUPUESTAL  AND
			META_VCH_IDMETA='0063')
 	FROM dbo.SICOP_CONTROLPRESUPUESTAL CP,
		 dbo.SICOP_DOCUMENTO DOC,
		 dbo.SICOP_ESPECIFICADEGASTO EGA
		 WHERE  CP.EGAS_VCH_IDESPECIFICADEGASTO =EGA.EGAS_VCH_IDESPECIFICADEGASTO AND
		 		CP.DOCU_INT_IDDOCUMENTO =DOC.DOCU_INT_IDDOCUMENTO ;
		 		
SELECT * FROM #TABLE_TEMP;
DROP TABLE #TABLE_TEMP;
GO

--EXEC USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT
--/////////////////////////////////////////////////////////
--USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT
--/////////////////////////////////////////////////////////
IF OBJECT_ID ( 'USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT', 'P' ) IS NOT NULL 
    DROP PROCEDURE USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT
go
CREATE PROCEDURE [dbo].[USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT]
	--ATRIBUTES OF TABLA SICOP_ESPECIFICADEGASTO WITH SICOP_META 

	AS
/*
	NOMBRE				: USP_S_SICOP_CONTROLPRESUPUESTAL_REPORT
	DESCRIPCION			: REPORTE DE GASTOS ESPECIFICOS CON SU DETALLE
	FECHA				: 04-09-2015
	AUTOR				: TEOFILO CHAMBILLA AQUINO
	ARGUMENTOS			:
	FEC. MODIFIC		: 
	AUTOR MODIFIC		: 
	CAMBIOS IMPORTANTE	: 
*/
SET NOCOUNT OFF;
CREATE TABLE #TABLE_TEMP_E (
META_VCH_IDMETA VARCHAR(4),
EGAS_VCH_IDESPECIFICADEGASTO VARCHAR(13),
MEGA_DEC_PIM DECIMAL(10,3),
ENERO DECIMAL(10,3),
FEBRERO DECIMAL(10,3),
MARZO DECIMAL(10,3),
ABRIL DECIMAL(10,3),
MAYO DECIMAL(10,3),
JUNIO DECIMAL(10,3),
JULIO DECIMAL(10,3),
AGOSTO DECIMAL(10,3),
SEPTIEMBRE DECIMAL(10,3),
OCTUBRE DECIMAL(10,3),
NOVIEMBRE DECIMAL(10,3),
DICIEMBRE DECIMAL(10,3),
TOTALEJECTUADO DECIMAL(10,3),
SADOEJERCICIO DECIMAL(10,3));

INSERT INTO #TABLE_TEMP_E(
META_VCH_IDMETA ,
EGAS_VCH_IDESPECIFICADEGASTO ,
MEGA_DEC_PIM ,
ENERO ,
FEBRERO ,
MARZO ,
ABRIL ,
MAYO ,
JUNIO ,
JULIO ,
AGOSTO ,
SEPTIEMBRE ,
OCTUBRE ,
NOVIEMBRE ,
DICIEMBRE ,
TOTALEJECTUADO ,
SADOEJERCICIO )
SELECT META_VCH_IDMETA ,
EGAS_VCH_IDESPECIFICADEGASTO ,
MEGA_DEC_PIM ,
0,--ENE
0,--FEB
0,--MAR
0,--ABR
0,--MAY
0,--JUN
0,--JUL
0,--AGO
0,--SET
0,--OCT
0,--NOV
0,--DIC
0,--EJE
0--SALDO
FROM SICOP_META_ESPECIFICADEGASTO 

SELECT * FROM #TABLE_TEMP_E;
DROP TABLE #TABLE_TEMP_E;

/* AGREGADO POR: EDÚ VERA --> INTENTO N° 01 AUN NO ACABADO... */
--EXEC USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT
--/////////////////////////////////////////////////////////
--USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT
--/////////////////////////////////////////////////////////
IF OBJECT_ID ( 'USP_S_SICOP_META_ESPECIFICADEGASTO_REPORT', 'P' ) IS NOT NULL 
    DROP PROCEDURE USP_S_SICOP_DETALLECONTROLPRESUPUESTAL_REPORT
go
CREATE PROCEDURE [dbo].[USP_S_SICOP_DETALLECONTROLPRESUPUESTAL_REPORT]
AS
SET NOCOUNT OFF;
CREATE TABLE #TABLE_TEMP_E (
META_VCH_IDMETA VARCHAR(4),
EGAS_VCH_IDESPECIFICADEGASTO VARCHAR(13) ,
MEGA_DEC_PIM DECIMAL(10,3),
MEGM_DEC_PIMMODIFICADO DECIMAL(10,3),
ENERO DECIMAL(10,3),
FEBRERO DECIMAL(10,3),
MARZO DECIMAL(10,3),
ABRIL DECIMAL(10,3),
MAYO DECIMAL(10,3),
JUNIO DECIMAL(10,3),
JULIO DECIMAL(10,3),
AGOSTO DECIMAL(10,3),
SEPTIEMBRE DECIMAL(10,3),
OCTUBRE DECIMAL(10,3),
NOVIEMBRE DECIMAL(10,3),
DICIEMBRE DECIMAL(10,3),
TOTAL DECIMAL(10,3),
SALDO DECIMAL(10,3));

INSERT INTO #TABLE_TEMP_E(
META_VCH_IDMETA,
EGAS_VCH_IDESPECIFICADEGASTO ,
MEGA_DEC_PIM,
MEGM_DEC_PIMMODIFICADO,
ENERO ,
FEBRERO ,
MARZO ,
ABRIL ,
MAYO ,
JUNIO ,
JULIO ,
AGOSTO ,
SEPTIEMBRE ,
OCTUBRE ,
NOVIEMBRE ,
DICIEMBRE ,
TOTAL ,
SALDO )
SELECT 
MEGA.META_VCH_IDMETA,
MEGA.EGAS_VCH_IDESPECIFICADEGASTO,
MEGA.MEGA_DEC_PIM,
MEGM.MEGM_DEC_PIMMODIFICADO,
 (SELECT DCPR_DEC_IMPORTE, MONTH(COP.CPRE_DAT_FECHAINGRESO) + ' ' + YEAR(COP.CPRE_DAT_FECHAINGRESO)
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE MEGA.EGAS_VCH_IDESPECIFICADEGASTO = EGA.EGAS_VCH_IDESPECIFICADEGASTO  AND
			  MEGA.META_VCH_IDMETA = MET.META_VCH_IDMETA  AND
			  META_VCH_IDMETA='0034'),
(SELECT DCPR_DEC_IMPORTE, MONTH(COP.CPRE_DAT_FECHAINGRESO) + ' ' + YEAR(COP.CPRE_DAT_FECHAINGRESO)  
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE MEGA.EGAS_VCH_IDESPECIFICADEGASTO = EGA.EGAS_VCH_IDESPECIFICADEGASTO  AND
			  MEGA.META_VCH_IDMETA = MET.META_VCH_IDMETA  AND
			META_VCH_IDMETA='0062'),
(SELECT DCPR_DEC_IMPORTE, MONTH(COP.CPRE_DAT_FECHAINGRESO) + ' ' + YEAR(COP.CPRE_DAT_FECHAINGRESO)
		FROM SICOP_DETALLECONTROLPRESUPUESTAL 
		WHERE MEGA.EGAS_VCH_IDESPECIFICADEGASTO = EGA.EGAS_VCH_IDESPECIFICADEGASTO  AND
			  MEGA.META_VCH_IDMETA = MET.META_VCH_IDMETA  AND
			META_VCH_IDMETA='0063')

 	FROM 
 		 dbo.SICOP_CONTROLPRESUPUESTAL COP,
		 dbo.SICOP_ESPECIFICADEGASTO EGA,
		 dbo.SICOP_META MET,
		 dbo.SICOP_META_ESPECIFICADEGASTO MEGA,
		 dbo.SICOP_META_ESPECIFICADEGASTO_MODIFICACIONES MEGM
		 
		 WHERE  EGA.EGAS_VCH_IDESPECIFICADEGASTO = MEGA.EGAS_VCH_IDESPECIFICADEGASTO AND
				MET.META_VCH_IDMETA = MEGA.META_VCH_IDMETA;

SELECT * FROM #TABLE_TEMP_E;
DROP TABLE #TABLE_TEMP_E;
GO

